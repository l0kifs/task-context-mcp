# План создания MCP сервера для AI-агента с сохранением и восстановлением контекста задачи

## 1. Анализ требований и архитектура

- **Определить цели:**
  - Сервер должен предоставлять инструменты (tools) для AI-агента через MCP (Model Context Protocol).
  - Агент сохраняет summary каждого шага задачи в БД (sqlite через SQLAlchemy).
  - Агент может быстро восстановить контекст задачи при переходе в новый чат.
  - Оптимизация summary для минимизации токенов без потери качества для агента.
- **Выбрать стек:**
  - MCP сервер: [FastMCP](https://gofastmcp.com/getting-started/welcome)
  - Менеджер пакетов: [uv](https://docs.astral.sh/uv/)
  - ORM и БД: SQLAlchemy + SQLite
  - Язык: Python 3.10+

## 2. Инициализация проекта и окружения

- Установить `uv` ([инструкция](https://docs.astral.sh/uv/))
- Создать проект: `uv init mcp-agent-server`
- Создать и активировать виртуальное окружение: `uv venv`
- Установить зависимости:
  - `uv add fastmcp sqlalchemy aiosqlite` (или `mcp[cli]` если нужен CLI)

## 3. Проектирование структуры БД

- Спроектировать таблицы:
  - `tasks` — уникальные задачи пользователя
  - `summaries` — summary по шагам (связь с задачей, номер шага, текст summary, timestamp)
- Реализовать модели SQLAlchemy

## 4. Реализация MCP сервера

- Создать сервер (`server.py`):
  - Инициализация FastMCP
  - Описание и регистрация инструментов:
    - `save_summary(task_id, step, summary)` — сохраняет summary шага
    - `get_task_context(task_id)` — возвращает оптимизированный контекст задачи (все summary)
    - `list_tasks()` — возвращает список всех задач пользователя
    - `new_task(task_title, ...)` — создает новую задачу и возвращает её id
- Реализовать оптимизацию summary:
  - Задача по сжатию/переформулированию summary для экономии токенов возлагается на агента.
  - Сервер предоставляет агенту правила сжатия через отдельный ресурс или инструмент (например, resource summary://compression_rules).
  - (Опционально) Сервер может валидировать длину summary и возвращать предупреждение при превышении лимита.

## 5. Интеграция с AI-агентом

- Описать, как агент будет вызывать MCP-инструменты для сохранения и восстановления контекста
- Протестировать сценарий: последовательные шаги задачи → сохранение summary → эмуляция нового чата → восстановление контекста

## 6. Тестирование и отладка

- Покрыть основные сценарии unit-тестами (минимум: сохранение, восстановление, оптимизация)
- Проверить работу сервера с клиентом (например, через Claude Desktop или тестовый MCP-клиент)

## 7. Документация

- Описать структуру БД, API инструментов, сценарии использования
- Добавить инструкции по запуску и настройке (README.md)

## 8. Оптимизация и масштабирование

- Оценить производительность при большом количестве задач/summary
- При необходимости реализовать дополнительные методы оптимизации хранения и выборки

## 9. Безопасность и приватность

- Убедиться, что данные пользователей не утекут за пределы сервера
- Добавить базовые меры защиты (валидация входных данных, ограничения доступа)

---

## Полезные ссылки

- FastMCP: <https://gofastmcp.com/getting-started/welcome>
- MCP спецификация: <https://modelcontextprotocol.io/quickstart/server>
- uv: <https://docs.astral.sh/uv/>
- SQLAlchemy: <https://docs.sqlalchemy.org/>
- Пример интеграции MCP с Claude: <https://generect.com/blog/claude-mcp/>
